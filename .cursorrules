# Nammayatri Cursor Rules — Root Router
# This file is always loaded. It contains critical rules and routes to topic docs.

## Critical Rules (Always Apply)

1. **NEVER edit files in `src-read-only/`** — these are generated by NammaDSL from YAML specs
2. **Always run `cabal build all`** after code generation to verify correctness
3. **Project uses `-Werror`** — all GHC warnings are compile errors (unused imports, etc.)
4. **ID generation**: `newId <- generateGUID` (from `Kernel.Utils.Common`)
5. **Error handling**: `entity <- QEntity.findById id >>= fromMaybeM (EntityNotFound id.getId)`
6. **DB inserts**: Call `create` from `Storage.Queries` directly; never wrap single creates in `runInTransaction`
7. **YAML imports**: Use full module paths (e.g., `Domain.Types.IntegratedBPPConfig`), not short names
8. **Beckn tags**: Must be defined in `lib/beckn-spec/src/BecknV2/OnDemand/Tags.hs` before use
9. **Orphan instances**: Go in `Domain/Types/Extra/*.hs` files
10. **Logging**: Use `logInfo`, `logDebug`, `logError` from `Kernel.Utils.Logging`

## Quick Reference — Service Ports

| Service | Port | Package |
|---------|------|---------|
| rider-app | 8013 | `app/rider-platform/rider-app/` |
| dynamic-offer-driver-app | 8016 | `app/provider-platform/dynamic-offer-driver-app/` |
| driver-offer-allocator | 9996 | `app/provider-platform/dynamic-offer-driver-app/Allocator/` |
| rider-app-scheduler | — | `app/rider-platform/rider-app/Scheduler/` |
| public-transport-rider-platform | — | `app/rider-platform/public-transport-rider-platform/` |

## Quick Reference — Key Directories

| Purpose | Path Pattern |
|---------|-------------|
| Domain types | `*/src/Domain/Types/` and `*/src-read-only/Domain/Types/` |
| Business logic | `*/src/Domain/Action/UI/` |
| Beckn callbacks | `*/src/Domain/Action/Beckn/` |
| API definitions | `*/src-read-only/API/` |
| DB queries | `*/src-read-only/Storage/Queries/` |
| Extra queries | `*/src/Storage/Queries/` |
| Cached queries | `*/src/Storage/CachedQueries/` or `*/src-read-only/Storage/CachedQueries/` |
| YAML API specs | `*/spec/API/*.yaml` |
| YAML Storage specs | `*/spec/Storage/*.yaml` |
| Beckn ACL | `*/src/Beckn/ACL/` |
| SharedLogic | `*/src/SharedLogic/` |
| Migrations | `dev/migrations/<service-name>/` |
| Dhall configs | `dhall-configs/dev/` |

## Databases

| Database | Schema (Rider/BAP) | Schema (Driver/BPP) |
|----------|--------------------|--------------------|
| PostgreSQL | `atlas_app` | `atlas_driver_offer_bpp` |
| Redis | Single 6379, Cluster 30001 | Same |
| ClickHouse | Analytics/events | Analytics/events |
| Kafka | Event streaming | Event streaming |

## Routing Table — Read the Right Doc

When working on a topic, read the corresponding doc from `.cursor/docs/`:

| If you're working on... | Read this doc |
|------------------------|---------------|
| First time / orientation | `00-index.md` |
| Service architecture, ports, package map | `01-architecture-overview.md` |
| Building, nix, cabal, code generation | `02-build-and-dev.md` |
| rider-app (customer side) code | `03-rider-app.md` |
| dynamic-offer-driver-app (driver side) code | `04-driver-app.md` |
| BECKN protocol (search → confirm → rating) | `05-beckn-protocol-flow.md` |
| End-to-end ride lifecycle | `06-ride-flow.md` |
| NammaDSL YAML specs, code generation | `07-namma-dsl.md` |
| Database queries, caching, migrations, Beam | `08-database-patterns.md` |
| Dashboard services | `09-dashboards.md` |
| FRFS / public transport / metro / bus | `10-frfs-public-transport.md` |
| Shared libraries (payment, scheduler, etc.) | `11-libraries.md` |
| Multi-cloud, KV connector, Redis | `12-multi-cloud.md` |
| External integrations (Juspay, OSRM, SMS) | `13-external-integrations.md` |
| Testing, debugging | `14-testing-and-debugging.md` |
| Haskell conventions, module organization | `15-conventions.md` |
| Status enums, state transitions | `16-status-definitions.md` |

## BECKN Protocol — Quick Summary

BAP (rider-app) sends: `search`, `select`, `init`, `confirm`, `status`, `track`, `cancel`, `update`, `rating`
BPP (driver-app) responds: `on_search`, `on_select`, `on_init`, `on_confirm`, `on_status`, `on_track`, `on_cancel`, `on_update`

ACL modules translate between BECKN protocol types and internal domain types.

## Commit / Branch Conventions

```
Commit: <sub-project>/<type>: <issue-number> <summary>
Branch: <sub-project>/<type>/<issue-number><description>
Types: feat, fix, chore, ci, docs, perf, refactor, test
```
