imports:
  Merchant: Domain.Types.Merchant
  MerchantOperatingCity: Domain.Types.MerchantOperatingCity
  SharedSearchRequest: Domain.Types.SharedSearchRequest
  Estimate: Domain.Types.Estimate
  Price: Kernel.Types.Common
  Seconds: Kernel.Types.Common
  Distance: Kernel.Types.Common
  ServiceTierType: Domain.Types.ServiceTierType
  TripCategory: Domain.Types.Common
  Money: Kernel.Types.Common
  HighPrecMoney: Kernel.Types.Common
  BaseUrl: Kernel.Types.Common
  TimeOfDay: Data.Time.LocalTime
  Centesimal: Kernel.Types.Common
  HighPrecDistance: Kernel.Types.Common
  Currency: Kernel.Types.Common
  DistanceUnit: Kernel.Types.Common
  HighPrecMeters: Kernel.Types.Common
  parseBaseUrl: Kernel.Prelude
  showBaseUrl: Kernel.Prelude

SharedEstimate:
  tableName: shared_estimate
  derives: "Generic,Show"

  types:
    EstimateStatus:
      enum: "NEW, DRIVER_QUOTE_REQUESTED, CANCELLED, GOT_DRIVER_QUOTE, DRIVER_QUOTE_CANCELLED, COMPLETED"
      derive: "HttpInstance"

  fields:
    id: Id SharedEstimate
    sharedSearchRequestId: Id SharedSearchRequest
    estimateIds: "[Id Estimate]"
    merchantId: Id Merchant
    merchantOperatingCityId: Id MerchantOperatingCity
    bppSharedEstimateId: Text
    providerId: Text
    providerName: Text
    providerUrl: BaseUrl
    serviceTierName: Maybe Text
    estimatedTotalFare: HighPrecMoney
    totalFareRangeMin: HighPrecMoney
    totalFareRangeMax: HighPrecMoney
    estimatedDuration: Maybe Seconds
    estimatedDistance: Maybe Distance
    vehicleServiceTierType: ServiceTierType|NoRelation
    vehicleServiceTierSeatingCapacity: Maybe Int
    nightShiftCharge: Maybe Money
    nightShiftChargeAmount: Maybe HighPrecMoney
    oldNightShiftCharge: Maybe Centesimal
    nightShiftStart: Maybe TimeOfDay
    nightShiftEnd: Maybe TimeOfDay
    status: EstimateStatus
    tripCategory: Maybe TripCategory
    validTill: UTCTime
    createdAt: UTCTime
    updatedAt: UTCTime

  constraints:
    id: PrimaryKey
    sharedSearchRequestId: SecondaryKey

  beamType:
    providerUrl: Text

  beamFields:
    estimatedDistance:
      estimatedDistance: Maybe HighPrecMeters
      estimatedDistanceValue: Maybe HighPrecDistance
      distanceUnit: Maybe DistanceUnit
    vehicleServiceTierType:
      vehicleVariant: ServiceTierType

  toTType:
    providerUrl: showBaseUrl|I
    estimatedDistance: (Kernel.Types.Common.distanceToHighPrecMeters <$> estimatedDistance)|E
    estimatedDistanceValue: (Kernel.Types.Common.distanceToHighPrecDistance <$> (estimatedDistance <&> (.unit)) <*> estimatedDistance)|E
    distanceUnit: (estimatedDistance <&> (.unit))|E
    vehicleVariant: vehicleServiceTierType|E

  fromTType:
    providerUrl: parseBaseUrl|MI
    estimatedDistance: (Kernel.Utils.Common.mkDistanceWithDefault distanceUnit estimatedDistanceValue <$> estimatedDistance)|E
    vehicleServiceTierType: vehicleVariant|E

  sqlType:
    sharedSearchRequestId: uuid
    estimateIds: "uuid[]"
    merchantId: character varying(36)
    merchantOperatingCityId: character varying(36)
    providerId: character varying(255)
    providerName: character varying(255)
    providerUrl: character varying(255)
    estimatedTotalFare: numeric(30,10)
    totalFareRangeMin: numeric(30,10)
    totalFareRangeMax: numeric(30,10)
    estimatedDuration: integer
    estimatedDistance: double precision
    vehicleServiceTierSeatingCapacity: integer
    nightShiftCharge: numeric(30,2)
    nightShiftChargeAmount: numeric(30,10)
    oldNightShiftCharge: numeric(10,2)
    nightShiftStart: time
    nightShiftEnd: time
    status: character varying(255)
    tripCategory: character varying(255)
    validTill: timestamptz
    createdAt: timestamptz
    updatedAt: timestamptz
    vehicleVariant: character varying(255)

  queries:
    findAllBySharedSearchRequestId:
      kvFunction: findAllWithKV
      where: sharedSearchRequestId

    updateStatus:
      kvFunction: updateOneWithKV
      params: [status]
      where: id

    findByStatus:
      kvFunction: findAllWithKV
      where: status
