imports:
  Merchant: Domain.Types.Merchant
  MerchantOperatingCity: Domain.Types.MerchantOperatingCity
  Person: Domain.Types.Person
  PassType: Domain.Types.PassType
  PaymentOrder: Lib.Payment.Domain.Types.PaymentOrder
  HighPrecMoney: Kernel.Types.Common
  FRFSVehicleServiceTier: Domain.Types.FRFSVehicleServiceTier
  ServiceTierType: BecknV2.FRFS.Enums

PurchasedPass:
  tableName: purchased_pass

  types:
    StatusType:
      enum: "Pending,Active,PreBooked,Failed,Expired,RefundPending,RefundInitiated,Refunded,RefundFailed,Invalidated"
      derive': "Show, Eq, Ord, Read, Generic, ToJSON, FromJSON, ToSchema, Kernel.Prelude.ToParamSchema"

    BenefitType:
      enum: "FullSaving,FixedSaving,PercentageSaving"
      derive': "Show, Eq, Ord, Read, Generic, ToJSON, FromJSON, ToSchema"

  domainInstance:
    - Custom Kernel.Beam.Lib.UtilsTH.mkBeamInstancesForEnum <StatusType>
    - Custom Kernel.Utils.TH.mkFromHttpInstanceForEnum <StatusType>
    - Custom Kernel.Beam.Lib.UtilsTH.mkBeamInstancesForEnum <BenefitType>
    - Custom Kernel.Utils.TH.mkFromHttpInstanceForEnum <BenefitType>

  fields:
    id: Id PurchasedPass
    passNumber: Int
    personId: Id Person
    startDate: Day
    endDate: Day
    passTypeId: Id PassType
    deviceId: Text
    deviceSwitchCount: Int
    passCode: Text
    passName: Maybe Text
    passDescription: Maybe Text
    passAmount: HighPrecMoney
    verificationValidity: Seconds
    benefitDescription: Text
    benefitType: Maybe BenefitType
    benefitValue: Maybe HighPrecMoney
    applicableVehicleServiceTiers: "[ServiceTierType]"
    maxValidTrips: Maybe Int
    maxValidDays: Maybe Int
    usedTripCount: Maybe Int
    status: StatusType
    merchantId: Id Merchant
    merchantOperatingCityId: Id MerchantOperatingCity
    passTypeCode: Maybe Text
    minAmount: HighPrecMoney
    maxAmount: HighPrecMoney

  beamType:
    deviceSwitchCount: Maybe Int
    verificationValidity: Maybe Seconds
    minAmount: Maybe HighPrecMoney
    maxAmount: Maybe HighPrecMoney

  fromTType:
    deviceSwitchCount: (fromMaybe 0 deviceSwitchCount)|E
    verificationValidity: Kernel.Prelude.fromMaybe 9000|I
    minAmount: (Kernel.Prelude.fromMaybe passAmount minAmount)|E
    maxAmount: (Kernel.Prelude.fromMaybe passAmount maxAmount)|E

  toTType:
    deviceSwitchCount: Just deviceSwitchCount|E
    verificationValidity: Just verificationValidity|E
    minAmount: Just minAmount|E
    maxAmount: Just maxAmount|E

  sqlType:
    applicableVehicleServiceTiers: text[]

  constraints:
    id: PrimaryKey

  extraOperations:
    - EXTRA_QUERY_FILE

  queries:
    updateDeviceSwitchCount:
      kvFunction: updateWithKV
      params: [deviceSwitchCount]
      where: id

PurchasedPassPayment:
  tableName: purchased_pass_payment

  fields:
    id: Id PurchasedPassPayment
    orderId: Id PaymentOrder
    passCode: Text
    passName: Maybe Text
    purchasedPassId: Id PurchasedPass
    amount: HighPrecMoney
    personId: Id Person
    startDate: Day
    status: Domain.Types.PurchasedPass.StatusType
    endDate: Day
    merchantId: Id Merchant
    merchantOperatingCityId: Id MerchantOperatingCity
    balance: HighPrecMoney

  sqlType:
    balance: double precision

  fromTType:
    balance: Kernel.Prelude.fromMaybe amount balance|E

  toTType:
    balance: Just balance|E

  beamType:
    balance: Maybe HighPrecMoney

  constraints:
    id: PrimaryKey
    orderId: SecondaryKey
    purchasedPassId: SecondaryKey
  queries:
    findOneByPaymentOrderId:
        kvFunction: findOneWithKV
        where: orderId

    findAllByPurchasedPassId:
      kvFunction: findAllWithKV
      where: purchasedPassId

    updateStatusByOrderId:
      kvFunction: updateOneWithKV
      params: [status]
      where: orderId

    findAllByPurchasedPassIdAndStatus:
      kvFunction: findAllWithOptionsKV
      where:
        and:
          - purchasedPassId
          - status
          - gte:
            - endDate
      orderBy:
        field: startDate
        order: asc

    findAllByPurchasedPassIdAndStatusStartDateGreaterThan:
      kvFunction: findAllWithOptionsKV
      where:
        and:
          - purchasedPassId
          - status
          - gte:
            - startDate
      orderBy:
        field: startDate
        order: asc

    findAllWithPersonId:
      kvFunction: findAllWithOptionsKV
      where: personId

    updateStatusByPurchasedPassIdAndStartEndDate:
      kvFunction: updateWithKV
      params: [status]
      where:
        and:
          - purchasedPassId
          - startDate
          - endDate

PassVerifyTransaction:
  tableName: pass_verify_transaction

  fields:
    id: Id PassVerifyTransaction
    purchasePassId: Id PurchasedPass
    validTill: UTCTime
    verifiedAt: UTCTime
    sourceStopCode: Maybe Text
    destinationStopCode: Maybe Text
    fleetId: Text
    purchasePassPaymentId: Maybe (Id PurchasedPassPayment)
    openingAmount: Maybe HighPrecMoney
    entryGateId: Maybe Text
    closingAmount: Maybe HighPrecMoney
    exitGateId: Maybe Text

  constraints:
    id: PrimaryKey
    purchasePassId: SecondaryKey

  queries:
    findAllByPurchasePassId:
      kvFunction: findAllWithKV
      where: purchasePassId
    updateOngoingPassVerifyTransaction:
      kvFunction: updateOneWithKV
      params: [destinationStopCode, exitGateId, closingAmount]
      where:
        and:
          - purchasePassId
          - fleetId
          - gte:
            - validTill

  extraOperations:
    - EXTRA_QUERY_FILE