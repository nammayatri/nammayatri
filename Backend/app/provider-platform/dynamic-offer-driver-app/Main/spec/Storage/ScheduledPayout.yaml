imports:
  Ride: Domain.Types.Ride
  Booking: Domain.Types.Booking
  Person: Domain.Types.Person
  Merchant: Domain.Types.Merchant
  MerchantOperatingCity: Domain.Types.MerchantOperatingCity

ScheduledPayout:
  tableName: scheduled_payout
  derives: "Generic,Show,Eq,ToJSON,FromJSON"
  types:
    ScheduledPayoutStatus:
      enum: "INITIATED,PROCESSING,CREDITED,AUTO_PAY_FAILED,RETRYING,FAILED,CANCELLED,CASH_PAID,CASH_PENDING"
  fields:
    id: Id ScheduledPayout
    rideId: Text
    bookingId: Text
    driverId: Text
    amount: Maybe HighPrecMoney
    status: ScheduledPayoutStatus
    retryCount: Maybe Int
    failureReason: Maybe Text
    payoutTransactionId: Maybe Text
    expectedCreditTime: Maybe UTCTime
    markCashPaidBy: Maybe (Id Person)
    createdAt: UTCTime
    updatedAt: UTCTime

  constraints:
    id: PrimaryKey
    rideId: SecondaryKey

  queries:
    findById:
      kvFunction: findOneWithKV
      where: id

    findByRideId:
      kvFunction: findOneWithKV
      where: rideId

    updateStatusById:
      kvFunction: updateOneWithKV
      params: [status]
      where: id

    updateMarkCashPaidByById:
      kvFunction: updateOneWithKV
      params: [markCashPaidBy]
      where: id

    updateStatusWithReasonByRideId:
      kvFunction: updateOneWithKV
      params: [status, failureReason]
      where: rideId

    incrementRetryCountByRideId:
      kvFunction: updateOneWithKV
      params: [retryCount]
      where: rideId

    updatePayoutTransactionIdById:
      kvFunction: updateOneWithKV
      params: [payoutTransactionId]
      where: id

    findByPayoutTransactionId:
      kvFunction: findOneWithKV
      where: payoutTransactionId
