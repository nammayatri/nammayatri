# Finance Kernel - Account Table
# Namma-DSL YAML specification

imports:
  UTCTime: Kernel.Prelude
  Currency: Kernel.Types.Common
  HighPrecMoney: Kernel.Types.Common

Account:
  tableName: finance_account
  derives: "Generic"

  types:
    AccountType:
      enum: "Asset,Liability,Revenue,Expense,External,RideCredit"
      derive: "ToParamSchema"

    CounterpartyType:
      enum: "BUYER,SELLER,DRIVER,FLEET_OWNER,GOVERNMENT_DIRECT,GOVERNMENT_INDIRECT"
      derive: "ToParamSchema"

    AccountStatus:
      enum: "Active,Suspended,Closed"
      derive: "ToParamSchema"

  fields:
    id: Id Account
    accountType: AccountType
    counterpartyType: Maybe CounterpartyType
    counterpartyId: Maybe Text
    currency: Currency
    balance: HighPrecMoney
    status: AccountStatus
    description: Maybe Text
    merchantId: Text
    merchantOperatingCityId: Text
    createdAt: UTCTime
    updatedAt: UTCTime

  constraints:
    id: PrimaryKey
    counterpartyId: "!SecondaryKey"

  queries:
    findById:
      kvFunction: findOneWithKV
      where: id

    findByCounterparty:
      kvFunction: findAllWithKV
      where:
        and: [counterpartyType, counterpartyId]

    findByCounterpartyAndType:
      kvFunction: findOneWithKV
      where:
        and: [counterpartyType, counterpartyId, accountType, currency]

    updateBalance:
      kvFunction: updateWithKV
      params: [balance, updatedAt]
      where: id

    updateStatus:
      kvFunction: updateWithKV
      params: [status, updatedAt]
      where: id

  defaultQueryTypeConstraint: "(Lib.Finance.Storage.Beam.BeamFlow.BeamFlow m r)"
  beamInstance: MakeTableInstancesGenericSchema
  domainInstance:
    - Custom Kernel.Beam.Lib.UtilsTH.mkBeamInstancesForEnumAndList <AccountType>
    - Custom Kernel.Beam.Lib.UtilsTH.mkBeamInstancesForEnumAndList <CounterpartyType>
    - Custom Kernel.Beam.Lib.UtilsTH.mkBeamInstancesForEnumAndList <AccountStatus>
